---
#
# Copyright (C) 2015 Orange
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# http://www.apache.org/licenses/LICENSE-2.0
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

resources:
- name: elpaaso-starter-parent
  type: git
  source:
    uri: {{starter-parent-git-url}}
    branch: {{starter-parent-git-branch}}

- name: elpaaso-sandbox-service
  type: git
  source:
    uri: {{sandbox-service-git-url}}
    branch: {{sandbox-service-git-branch}}

- name: elpaaso-sandbox-ui
  type: git
  source:
    uri: {{sandbox-ui-git-url}}
    branch: {{sandbox-ui-git-branch}}

- name: elpaaso-sandbox-boshrelease
  type: git
  source:
    uri: {{sandbox-boshrelease-git-url}}
    branch: {{sandbox-boshrelease-git-branch}}

- name: sandbox-boshrelease-master
  type: git
  source:
    uri: {{sandbox-boshrelease-git-url}}
    branch: {{sandbox-boshrelease-master-branch}}


- name: boshrelease-version
  type: semver
  source:
    bucket: {{aws-sandbox-candidate-bucket}}
    key: current-version
    initial_version: 1.0.0
    access_key_id: {{aws-access-key-id}}
    secret_access_key: {{aws-secret-access-key}}
    region_name: {{aws-sandbox-region}}


- name: bosh-final-release
  type: s3
  source:
    bucket: {{aws-sandbox-bucket}}
    regexp: elpaaso-sandbox-boshrelease-(.*).tgz
    access_key_id: {{aws-access-key-id}}
    secret_access_key: {{aws-secret-access-key}}
    region_name: {{aws-sandbox-region}}

- name: bosh-release-candidate
  type: s3
  source:
    bucket: {{aws-sandbox-candidate-bucket}}
    regexp: elpaaso-sandbox-boshrelease-(.*).tgz
    access_key_id: {{aws-access-key-id}}
    secret_access_key: {{aws-secret-access-key}}
    region_name: {{aws-sandbox-region}}

- name: sandbox-deployment
  type: bosh-deployment
  source:
    target: {{bosh-deployment-target}}
    username: {{bosh-deployment-user}}
    password: {{bosh-deployment-password}}
    deployment: elpaaso-sandbox-ci
    ignore_ssl: true

- name: resource-bosh-stemcell
  type: bosh-io-stemcell
  source:
    name: {{bosh-stemcell-name}}

- name: resource-manifests
  type: git
  source:
    uri: {{resource-manifests-uri}}
    skip_ssl_verification: {{resource-manifests-skip-ssl-verification}}
    paths: [deployments/elpaaso-sandbox-ci/]

- name: route-registrar-boshrelease
  type: bosh-io-release
  source:
    repository: cloudfoundry-community/route-registrar-boshrelease

jobs:
- name: jobs-elpaaso-starter-parent
  plan:
  - get: elpaaso-starter-parent
    trigger: true
  - task: unit-test
    #file: elpaaso-sandbox-ui/ci/unit-test.yml
    config:
      platform: linux
      image: docker:///java#8-jdk
      inputs:
       - name: elpaaso-starter-parent
      run:
        path: ls
        args: [-lrt]

- name: jobs-elpaaso-sandbox-service
  plan:
  - aggregate:
    - get: elpaaso-starter-parent
      trigger: true
      passed: [jobs-elpaaso-starter-parent]
    - get: elpaaso-sandbox-service
      trigger: true
  - task: unit-test
    file: elpaaso-sandbox-service/ci/unit-test.yml
  - task: deploy
    file: elpaaso-sandbox-service/ci/deploy.yml
    config:
      params:
        BINTRAY_USER: {{bintray_username}}
        BINTRAY_PASSWORD: {{bintray_password}}

- name: jobs-elpaaso-sandbox-ui
  plan:
  - aggregate:
    - get: elpaaso-starter-parent
      trigger: true
      passed: [jobs-elpaaso-starter-parent]
    - get: elpaaso-sandbox-ui
      trigger: true
  - task: unit-test
    file: elpaaso-sandbox-ui/ci/unit-test.yml
  - task: deploy
    file: elpaaso-sandbox-ui/ci/deploy.yml
    config:
      params:
        BINTRAY_USER: {{bintray_username}}
        BINTRAY_PASSWORD: {{bintray_password}}

- name: jobs-elpaaso-sandbox-boshrelease
  plan:
  - aggregate:
    - get: elpaaso-sandbox-service
      trigger: true
      passed: [jobs-elpaaso-sandbox-service]
    - get: elpaaso-sandbox-ui
      trigger: true
      passed: [jobs-elpaaso-sandbox-ui]
    - get: elpaaso-sandbox-boshrelease
      trigger: true
    - get: boshrelease-version
      params: {pre: rc}
  - task: create-release-candidate
    file: elpaaso-sandbox-boshrelease/ci/create-release-candidate.yml
    config:
      params:
        GH_USER: {{github-username}}
        GH_USER_EMAIL: {{github-email}}
        GH_TOKEN: {{github-token}}
  - put: bosh-release-candidate
    params: {file: bosh-release-candidate/elpaaso-sandbox-boshrelease-*.tgz}
  - put: boshrelease-version
    params: {pre: rc}

- name: jobs-elpaaso-sandbox-boshrelease-deploy
  plan:
  - aggregate:
    - get: bosh-release-candidate
      passed: [jobs-elpaaso-sandbox-boshrelease]
      trigger: true
      attempts: 3
    - get: route-registrar-boshrelease
      trigger: true
      attempts: 3
    - get: resource-manifests
      trigger: true
      params: { submodules: none}
      attempts: 3
  - put: sandbox-deployment
    params:
      manifest: resource-manifests/deployments/elpaaso-sandbox-ci/elpaaso-sandbox-ci.yml
      releases:
      - bosh-release-candidate/*.tgz
      - route-registrar-boshrelease/*tgz
      stemcells: []
      # - resource-bosh-stemcell/*.tgz
    attempts: 10

#- name: elpaaso-sandbox-boshrelease-acceptance-test
#  plan:
#  - aggregate:
#    - get: bosh-release-candidate
#      passed: [jobs-elpaaso-sandbox-boshrelease-deploy]
#      trigger: true

- name: promote-elpaaso-sandbox-boshrelease
  plan:
  - aggregate:
    - get: bosh-release-candidate
#      passed: [jobs-elpaaso-sandbox-boshrelease-deploy, elpaaso-sandbox-boshrelease-acceptance-test]
      passed: [jobs-elpaaso-sandbox-boshrelease-deploy]

- name: jobs-elpaaso-sandbox-boshrelease-final
  plan:
  - aggregate:
    - get: bosh-release-candidate
      passed: [promote-elpaaso-sandbox-boshrelease]
      trigger: true
    - get: elpaaso-sandbox-boshrelease
      passed: [jobs-elpaaso-sandbox-boshrelease]
    - get: boshrelease-version
      params: {bump: final}
  - task: finalize-release
    file: elpaaso-sandbox-boshrelease/ci/finalize-release.yml
    config:
      params:
        GH_USER: {{github-username}}
        GH_USER_EMAIL: {{github-email}}
        GH_TOKEN: {{github-token}}
  - aggregate:
#    - put: boshrelease-version
#      params:
    - put: sandbox-boshrelease-master
      params:
        repository: final-release-repo
        tag: version/version
        tag_prefix: v
#    - put: bosh-final-release
#      params: {file: bosh-final-release/elpaaso-sandbox-boshrelease-*.tgz}


- name: NEW-major
  plan:
  - put: boshrelease-version
    params: {bump: major, pre: rc}
- name: NEW-minor
  plan:
  - put: boshrelease-version
    params: {bump: minor, pre: rc}